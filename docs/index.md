# Candy

A WebSocket and TUN based VPN for Linux 

## Design

### The simplest usage of TUN/TAP

Refer to [simpletun](https://github.com/gregnietsky/simpletun) for the simplest peer-to-peer communication.
Here the two peers are named Client A and client B.

```txt
┌──────────┐  ┌──────────┐
│ Client A ├──┤ Client B │
└──────────┘  └──────────┘
```

### Server traffic forwarding

On the basis of peer-to-peer communication, a device is added in the middle for traffic forwarding.
There is no change in the traffic sent and received by the two clients.

```txt
┌──────────┐  ┌────────┐  ┌──────────┐
│ Client A ├──┤ Server ├──┤ Client B │
└──────────┘  └────────┘  └──────────┘
```

### Server traffic routing

On the basis of forwarding, the Server analyzes the IP data packets uploaded by the Client.
Routing is performed according to the destination address, and the clients can communicate with each other

```txt
┌──────────┐   ┌────────┐   ┌──────────┐
│ Client A ├───┤ Server ├───┤ Client B │
└──────────┘   └───┬────┘   └──────────┘
                   │
              ┌────┴─────┐
              │ Client C │
              └──────────┘
```

### Access Server via VPN

Deploy Client D on the physical machine where the Server is located. This Client is no different from other Clients.
At this point, all devices can communicate with each other.

```txt
              ┌──────────┐
              │ Client D │
              └────┬─────┘
                   │
┌──────────┐   ┌───┴────┐   ┌──────────┐
│ Client A ├───┤ Server ├───┤ Client B │
└──────────┘   └───┬────┘   └──────────┘
                   │
              ┌────┴─────┐
              │ Client C │
              └──────────┘
```

### Network traffic between devices

For some well-known reasons, TLS + WebSocket is used for communication.

## Packet Content

### Handshake packet

Only sent by the client to the server, the server does not generate any response. If the handshake packet is valid, it will map the TUN IP to the WebSocket, and when other devices access the client, they will receive the IP packet.

- The packet should contain a Type field to distinguish the packet type, occupying 1 byte (8 bits)
- The packet should contain a TUN IP field. Used to establish a mapping between the destination address and WebSocket, occupying 4 bytes (32 bits)
- The packet should contain a TimeStamp field to check the handshake time and avoid replay attacks. Occupying 8 bytes (64 bits)
- The packet should contain a Hash field for authentication. Occupying 32 bytes (256 bits). The Hash value is generated by TimeStamp and the password configured by the server
- The packet can contain an obfuscation field, occupying random bytes and randomly filling bytes. Used to hide the fixed length feature of the handshake packet.

### IP packet forwarding packet

Sent by the client and server to each other, the client forwards data read from TUN to Server, and forwards data received from Server to TUN. After receiving the packet, Server analyzes the source address IP, verifies whether IP and Websocket have established a mapping, obtains the destination address IP, and forwards the packet to the corresponding WebSocket.

- The packet should contain a Type field to distinguish the packet type, occupying 1 byte (8 bits)
- The packet should contain IP layer raw data

