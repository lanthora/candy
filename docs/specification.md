# 协议规范

[主页](index.md) | 协议规范 | [服务端转发原理](forward.md) | [对等连接](peer-to-peer.md)

## 握手消息

握手消息由客户端发送给服务器,无论认证是否通过,服务器都不会产生任何响应.

- Type: 用于区分数据包类型，始终为 0
- TUN IP: 用于建立目的地址与 WebSocket 之间的映射
- Timestamp: 用于检查握手时间,避免重放攻击
- Hash: 用于身份认证,由密码,TUN IP 和时间戳生成
- Confusion: 用于隐藏报文的固定长度特征,占用随机长度,填充随机内容

```plaintext
+--------------------------------------------------------------------------------------------------+
| Type (1 Byte) | TUN IP (4 Bytes) | Timestamp (8 Bytes) | Hash (32 Bytes) | Confusion (n Byte[s]) |
+--------------------------------------------------------------------------------------------------+
```

## IP 数据包转发消息

客户端和服务器互相发送,客户端将从 TUN 读取的数据转发到服务器,将从服务器接收到的数据转发到 TUN.服务器收到数据包后,解析源地址 IP, 验证 IP 与Websocket 的映射关系是否建立,获取目的地址 IP, 并将数据包转发给对应的 WebSocket.

- Type: 用于区分数据包类型,始终为 1
- Raw: IP 层原始数据

```plaintext
+-------------------------------+
| Type (1 Byte) | Raw (n Bytes) |
+-------------------------------+
```

## 动态地址消息

客户端使用动态地址消息向服务器请求可用地址.

- Type: 用于区分数据包类型,始终为 2
- Timestamp: 用于检查握手时间,避免重放攻击
- CIDR: 以“\0”结尾的字符串,客户端携带想要使用的地址,服务端优先尝试分配这个地址
- Hash: 用于身份认证,由密码,TUN IP 和时间戳生成
- Confusion: 用于隐藏报文固定长度特征,占用随机长度,填充随机内容

```plaintext
+-------------------------------------------------------------------------------------------------+
| Type (1 Byte) | Timestamp (8 Bytes) | CIDR (32 Bytes) | Hash (32 Bytes) | Confusion (n Byte[s]) |
+-------------------------------------------------------------------------------------------------+
```

## 对等连接公网信息交换消息

对等连接的客户端双方通过服务端传递双方公网信息.

- Type: 用于区分数据包类型,始终为 3
- Src: 虚拟源地址
- Dst: 虚拟目的地址
- IP: 本客户端用于对等连接的公网地址
- Port: 本客户端用于对等连接监听的公网端口

```plaintext
+-------------------------------------------------------------------------------+
| Type (1 Byte) | Src (4 Bytes) | Dst (4 Bytes) | IP (4 Bytes) | Port (2 Bytes) |
+-------------------------------------------------------------------------------+
```

### 对等连接时使用的消息

用 UDP 建立和使用对等连接过程中,也存在特定格式的消息,这些消息全程加密.

#### 心跳和握手

心跳和握手使用完全相同的报文格式.

- Type: 用于区分数据包类型,始终为 0
- TUN: 本机虚拟地址
- IP: 本客户端用于对等连接的公网地址
- Port: 本客户端用于对等连接监听的公网端口
- ACK: 0 或 1, 表示是否已经收到了对方的心跳或握手消息,用于更新对等连接状态机

```plaintext
+------------------------------------------------------------------------------+
| Type (1 Byte) | TUN (4 Bytes) | IP (4 Bytes) | Port (2 Bytes) | ACK (1 Byte) |
+------------------------------------------------------------------------------+
```

#### 原始 IPv4 报文转发

与通过 WebSocket 转发的报文格式一致.但这是使用的是 UDP 传输.

- Type: 用于区分数据包类型,始终为 1
- Raw: IP 层原始数据

```plaintext
+-------------------------------+
| Type (1 Byte) | Raw (n Bytes) |
+-------------------------------+
```
