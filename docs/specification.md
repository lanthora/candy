# Specification

We use WebSocket to transmit data, which is a reliable message-oriented transmission method without considering the problems of TCP "sticky packets" and UDP packet loss.

## Handshake Message

The handshake message is sent from the client to the server, and the server does not generate any response whether the authentication is passed or not.

- Type field, used to distinguish the packet type, occupying 1 byte (8 bits)
- TUN IP field, used to establish a mapping between the destination address and WebSocket, occupying 4 bytes (32 bits)
- Timestamp field, used to check the handshake time and avoid replay attacks, occupying 8 bytes (64 bits)
- Hash field, used for identity authentication, generated by password, TUN IP and Timestamp, occupying 32 bytes (256 bits).
- Confusion field, used to hide the fixed-length feature of the handshake packet, occupy a random length, and fill with random content

```plaintext
+--------------------------------------------------------------------------------------------------+
| Type (1 Byte) | TUN IP (4 Bytes) | Timestamp (8 Bytes) | Hash (32 Bytes) | Confusion (n Byte[s]) |
+--------------------------------------------------------------------------------------------------+
```

Type is 0. TUN IP and Timestamp are network sequences. Hash value is calculated from password, TUN IP and Timestamp through SHA256.


## IP Packet Forwarding Message

The client and the server send each other, the client forwards the data read from TUN to the server, and forwards the data received from the server to TUN. After receiving the data packet, the server analyzes the source address IP, verifies whether the mapping relationship between IP and Websocket has been established, obtains the destination address IP, and forwards the data packet to the corresponding WebSocket.

- Type field, used to distinguish the packet type, occupying 1 byte (8 bits)
- Raw field, IP layer raw data

```plaintext
+-------------------------------+
| Type (1 Byte) | Raw (n Bytes) |
+-------------------------------+
```

Type is 1.

## Synamic Address Message

```plaintext
+-------------------------------------------------------------------------+
| Type (1 Byte) | Timestamp (8 Bytes) | CIDR (32 Bytes) | Hash (32 Bytes) |
+-------------------------------------------------------------------------+
```
