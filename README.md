# Candy

另一个支持对等连接的虚拟专用网络工具.

## 什么是虚拟专用网络

互联网上存在大量命名为 VPN (虚拟专用网络)的代理工具,严格意义上来说这些工具应该被称为 Proxy (代理).
这里需要澄清一下它们的区别: VPN 可以让虚拟网络中的设备相互访问; Proxy 则是把一台设备作为跳板访问另一台设备.

典型的 VPN 有 OpenVPN 和 IPSec, 以及最近几年出现的 WireGuard.
典型的 Proxy 有 Socks5, ShadowSocks, V2Ray.

显然本项目是组网工具,而非翻墙工具.

## 为什么再实现一款虚拟专用网络工具

上面已经提到许多经典的 VPN, 它们能满足用户的绝大多数场景.
我曾是 WireGuard 用户,但在国内众所周知的网络环境下,它们的设计存在"协议特征"明显这个“缺陷”.
这原本不是 VPN 需要考虑的问题,但当流量通过防火墙时,存在被丢包的风险.
我就是在 WireGuard 被丢包后才决定实现一款不容易被防火墙屏蔽的 VPN.

## 还得添加一些新特性

除了解决被防火墙屏蔽的问题,还需要引入一些更方便高效实用的新特性.

### 降低配置复杂度

WireGuard 相对来说已经是 VPN 里配置比较简单的了,但依旧需要手动在服务端和客户端配置对方的公钥.能理解这是为了安全所采取的措施,但对我来说依旧过于复杂. WireGuard 需要强制指定虚拟地址,不适用于想要灵活接入多个客户端并动态分配地址的场景.用预共享密钥代替非对称加密,可以解决前面提到的问题,同时降低配置复杂度.

### 高效的断线重连

在某些情况下 WireGuard 会断线,只有重启客户端才能解决.此时对于一个无人值守的设备,就意味着彻底失联.曾经为了解决这个问题,给设备配置每天重启一次,这显然是一种很丑陋的解决方案.自己实现时就可以加上心跳,在收不到心跳时及时重连.

### 穿透 NAT 建立对等连接

虽然 WireGuard 也支持对等连接,但对于连接双方都在 NAT 后面的情况却无能为力.当能穿透 NAT 时,就可以节约服务端转发的流量,同时还能降低通信延迟.

## 如何实现这些特性

思考了很久,不知道是否有必要在这里讲实现原理,最后决定用较少的篇幅做简单的描述.

要解决被防火墙丢包这个核心问题,可以参考目前代理的实现.主流方案是把流量伪装成已知的协议,主要是 HTTPS. 因此选择用 TLS + WebSocket 与服务端通信,不仅解决了防火墙的问题,还简化了通信的设计难度.

断线重连只需要利用 WebSocket 的 Ping/Pong, 这个包通过 TCP 发送,如果没有及时收到响应,可以认为断开连接.此时客户端退出进程,服务端清理连接.由外部进程重新拉起客户端进行重连.目前的实现心跳包的间隔是 30 秒,对我来说这个频率可以接受,实际使用过程中没有出现过有感知的断连的情况.

穿透 NAT 建立对等连接的实现与互联网公开方案基本一致.通过 STUN 服务器获取本地 UDP Socket 被映射后的公网地址和端口,通过 Server 与其他客户端交换端口信息,然后尝试建立连接,如果能成功建连就通过直连处理数据,否则通过服务端转发.

## 如何安装

### Linux

建议使用 Docker 镜像,已上传到 [Docker Hub](https://hub.docker.com/r/lanthora/candy) 和 [Github Packages](https://github.com/lanthora/candy/pkgs/container/candy).

Candy 会缓存上次从服务端分配到的地址,并在下次启动时优先申请使用这个地址,地址保存在 `/var/lib/candy` 目录下,启动容器服务前需要在 Host 创建一个目录用于映射,否则容器重启丢失数据将导致重新分配地址.方便理解创建与容器内相同的目录.

```bash
mkdir -p /var/lib/candy
```

容器需要管理员权限读取设备创建虚拟网卡并设置路由,同时需要 Host 网络命名空间共享虚拟网卡.

```bash
docker run --rm --privileged=true --net=host --volume /var/lib/candy:/var/lib/candy docker.io/lanthora/candy:latest
```

Arch Linux 用户可以使用 [AUR](https://aur.archlinux.org/packages/candy).

### MacOS

请参考 [Homebrew](https://github.com/lanthora/homebrew-repo) 仓库中提供的方法安装.

Mac 默认的睡眠策略是: 1.在关闭屏幕一段时间后睡眠; 2.睡眠时收到网络包唤醒. Candy 运行过程中每 30 秒产生一个心跳,这会导致机器被频繁唤醒.对于作为服务器长期开机的 Mac 设备来说,可以关闭睡眠功能;对于作为普通设备的笔记本来说,可以关闭网络唤醒功能.参考苹果官网[睡眠与唤醒](https://support.apple.com/zh-cn/guide/mac-help/mchle41a6ccd/mac)完成设置.

### Windows

在 [Release](https://github.com/lanthora/candy/releases/latest/) 中提供安装包.对于无人值守的设备: 1.请确认系统不会休眠; 2.进程启动需要管理员权限设置虚拟网卡,请确认进程不会因为用户账户控制无法正常开机启动.

### 从源码构建

可以参考 [Github Actions](.github/workflows/check.yaml) 和 [Dockerfile](dockerfile) 了解各系统构建时所需的环境.

## 如何使用

### 接入我们的网络

上述客户端的[默认配置](candy.conf)会连到我们提供的测试网络 172.16.0.0/16, 并被随机分配一个地址.

这个网络部署了两个用于测试的客户端. 172.16.0.1 的 80 端口部署了 Web 服务. 172.16.0.2 的 1080 端口部署了的 socks5 服务.

### 部署自己的网络

参数可以由命令行指定.也可以通过配置文件指定.使用配置文件时需要指定路径.推荐使用配置文件,可以在不重建容器的情况下修改配置.

```bash
candy -c /path/to/candy.conf
```

#### 服务端

监听所有网卡的 80 端口,客户端连接后自动在 10.0.0.0/24 子网分配地址,并设置登录密码为 123456

```bash
candy -m server -w ws://0.0.0.0:80 -d 10.0.0.0/24 -p 123456
```

对应的配置文件内容为

```bash
mode = "server"
# 服务端不支持 wss, 需要由外部的服务加密,例如 nginx/caddy, 公网服务建议使用 wss
websocket = "ws://0.0.0.0:80"
# 不配置此项时,客户端需要指定静态地址
dhcp = "10.0.0.0/24"
# 不配置此项时,口令为空
password = "123456"
```

#### 客户端

```bash
candy -m client -w ws://127.0.0.1:80 -p 123456
# 启用对等连接
candy -m client -w ws://127.0.0.1:80 -p 123456 -s stun://stun.qq.com
# 指定静态地址
candy -m client -w ws://127.0.0.1:80 -p 123456 -t 10.0.0.1/24
# 设置网卡名
candy -m client -w ws://127.0.0.1:80 -p 123456 -n test
```

对应的配置文件内容为

```bash
mode = "client"
# 客户端支持 wss 协议
websocket = "ws://127.0.0.1:80"
# 服务端配置 dhcp 时,客户端可以不配置静态地址
tun = "10.0.0.1/24"
# 需要与服务端配置保持一致
password = "123456"
# 网卡名,区分单个机器上的多个客户端,仅一个客户端时可不配置
name = "test"
# 对等连接服务器,不配置此项标识不启用对等连接
stun = "stun://stun.qq.com"
```

## 这个软件给我带来了什么

预期之内的,替代 WireGuard 完成组网,让我国内外的设备又可以在同一个虚拟网络下工作.

更多的还是意料之外的惊喜.首先是认识到可以通过软件模拟网络设备实现 VPN.

其次,为了方便容器化部署,我终于学会了用 Github Actions, 代码提交后自动检查并生成镜像上传.

对于软件本身,由于部署过于简单,就让我可能需要的设备都参与了组网.进而轻易解决了公司的 VPN 没有 Linux 版的问题.我把 Shadowsocks 部署在 VPN 里,也解决了 Splatoon 3 掉线问题.这次回家买了个 Mac mini, 接入由树莓派制作的 AP, 由于在树莓派上也接入的虚拟网络,因此可以直接在 Mac mini 上访问所有接入了网络的设备.同时由于对等连接的功劳,这些设备之间访问的延迟非常低.后来完成 Mac 版本后,在 Mac mini 上也部署了客户端.

## 未来的发展方向

除了正常的安全更新和问题修复,短期内不计划新增任何功能,希望这个软件可以像空气一样,让用户意识不到它的存在.

## 联系我们

[Telegram Group](https://t.me/CandyUserGroup)
